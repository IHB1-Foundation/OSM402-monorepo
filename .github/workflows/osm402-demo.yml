name: OSM402 Demo

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'OSM402 API URL'
        required: true
        default: 'http://localhost:3000'
      issue_number:
        description: 'Issue number to fund'
        required: false
        default: '1'
      bounty_amount:
        description: 'Bounty amount in USD'
        required: false
        default: '10'
  issues:
    types: [labeled]

jobs:
  osm402-fund:
    runs-on: ubuntu-latest
    # Only run for bounty labels or manual dispatch
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && startsWith(github.event.label.name, 'bounty:$'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd apps/github-action
          npm install

      - name: Build action
        run: |
          cd apps/github-action
          npm run build

      - name: Run OSM402 Fund Action
        id: fund
        uses: ./apps/github-action
        with:
          api_url: ${{ github.event.inputs.api_url || secrets.OSM402_API_URL || 'http://localhost:3000' }}
          action_secret: ${{ secrets.OSM402_ACTION_SHARED_SECRET }}
          payer_address: ${{ secrets.X402_PAYER_ADDRESS || '0x0000000000000000000000000000000000000001' }}
          issue_number: ${{ github.event.inputs.issue_number || '' }}
          bounty_amount: ${{ github.event.inputs.bounty_amount || '' }}

      - name: Print result
        run: |
          echo "Result: ${{ steps.fund.outputs.result }}"
          echo "Escrow: ${{ steps.fund.outputs.escrow_address }}"
          echo "Deposit TX: ${{ steps.fund.outputs.deposit_tx }}"
          echo "Intent Hash: ${{ steps.fund.outputs.intent_hash }}"
